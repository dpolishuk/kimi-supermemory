{"id":"kimi-supermemory-6tb","title":"Task 1: Build configuration system and logging service","design":"## Goal\nBuild foundational infrastructure: configuration system and logging service. These services are prerequisites for all other tools and services in the epic. Configuration loader handles XDG config directories, JSON parsing, env variable overrides, and graceful degradation. Logger provides structured logging to file with timestamped entries and multiple log levels.\n\n## Implementation\n\n1. **Study existing code**\n   - Review mcp-server/src/supermemory-client.js to understand client pattern\n   - Review mcp-server/src/supermemory-client.js environment variable usage\n   - Note: current implementation reads API key from process.env.SUPERMEMORY_API_KEY\n\n2. **Write tests first (TDD)**\n   - Create tests for config loading (config file, defaults, env override)\n   - Create tests for logging (timestamp format, log levels, file writing)\n   - Create tests for XDG config dir detection\n\n3. **Implementation checklist**\n   - mcp-server/src/services/config.ts - Configuration loader with XDG detection, DEFAULTS, env override\n   - mcp-server/src/services/logger.ts - Structured logging to ~/.kimi-supermemory.log (logInfo, logWarn, logError, logDebug)\n   - Tests in mcp-server/test/config.test.ts and mcp-server/test/logger.test.ts\n   - Integration test: Verify config loads correctly and logs write to file\n\n## Success Criteria\n\n**Configuration Loading**:\n- [ ] Config loads correctly from ~/.config/kimi/supermemory.jsonc when present\n- [ ] Config loads from ~/.kimi/supermemory.json as fallback when .jsonc not found\n- [ ] Environment variable SUPERMEMORY_API_KEY overrides config file apiKey\n- [ ] Environment variable SUPERMEMORY_API_URL overrides config file apiUrl\n- [ ] DEFAULTS applied when config file missing or invalid JSON\n- [ ] Invalid JSON in config file logged as warning and defaults used (no crash)\n\n**Logging Functionality**:\n- [ ] Logging writes to ~/.kimi-supermemory.log with ISO timestamp [2026-02-05T12:30:45.123Z]\n- [ ] All 4 log levels (INFO, WARN, ERROR, DEBUG) working correctly with proper formatting\n- [ ] Log file directory created automatically if missing (mkdir with recursive: true)\n- [ ] Log write failures to stderr fallback (degrade gracefully, no crash)\n- [ ] logDebug() only writes when DEBUG_MODE enabled (filtering in prod)\n\n**Test Coverage**:\n- [ ] 12+ unit tests pass covering config and logger edge cases\n- [ ] npm test passes with all tests green\n- [ ] npm run lint passes eslint checks\n- [ ] npm run typecheck passes TypeScript validation\n\n## Detailed Steps\n\n**Step 1: Create config service**\n- Define SupermemoryConfig interface (apiKey, apiUrl, similarityThreshold, maxMemories, maxProjectMemories, maxProfileItems, injectProfile, containerTagPrefix, keywordPatterns, debug, allowPrivateContent)\n- Implement getHomeConfigDir() to detect ~/.config/kimi or ~/.kimi (XDG standard preference)\n- Implement loadConfig() with XDG detection in CONFIG_FILES order: ~/.config/kimi/supermemory.jsonc → ~/.config/kimi/supermemory.json → ~/.kimi/supermemory.jsonc → ~/.kimi/supermemory.json\n- Apply DEFAULTS for all values (except apiKey which may be in env)\n- Read JSON from config files, handle JSON.parse errors gracefully\n- Override with env vars: SUPERMEMORY_API_KEY, SUPERMEMORY_API_URL\n- Test config loading with valid files, invalid JSON, missing files, env overrides\n\n**Step 2: Create logger service**\n- Define log file path: ~/.kimi-supermemory.log\n- Implement log() with timestamp (ISO format toISOString()) + level + message + optional JSON data\n- Implement logInfo(), logWarn(), logError(), logDebug() helpers\n- Add ensureLogFile() to create directory if needed (mkdirSync with recursive: true, catch errors)\n- Add graceful error handling: if fs.appendFileSync fails, log to stderr instead\n\n**Step 3: Write tests**\n- **test/config.test.ts**:\n  - test_config_loads_from_jsonc_file: Loads valid JSONC with all fields\n  - test_config_loads_from_json_fallback: Falls back to .json when .jsonc missing\n  - test_env_override_apiKey: SUPERMEMORY_API_KEY overrides config file\n  - test_env_override_apiUrl: SUPERMEMORY_API_URL overrides config file\n  - test_invalid_json_uses_defaults: Invalid JSON logged as warning, defaults used\n  - test_missing_file_uses_defaults: No config file found, defaults used\n  - test_xdg_config_dir_preferred: ~/.config/kimi checked before ~/.kimi\n  \n- **test/logger.test.ts**:\n  - test_log_format_timestamp_iso: Timestamp in ISO 8601 format\n  - test_log_levels_formatted_correctly: INFO, WARN, ERROR, DEBUG prefixed correctly\n  - test_log_creates_directory: Creates parent directory if missing\n  - test_log_writes_to_file: Content written to ~/.kimi-supermemory.log\n  - test_log_debug_only_when_enabled: DEBUG logs only when debugMode=true\n  - test_log_write_fails_gracefully: fs.appendFileSync error falls back to stderr without crash\n\n**Step 4: Integration**\n- Update server.js to load config on startup\n- Use Config.loadConfig() to initialize configuration\n- Use config.similarityThreshold, maxMemories, etc. in tool handlers\n- Call logger.logInfo() on successful server startup\n- Call logger.logError() on failures (catch Error, log message, don't throw)\n\n## Anti-Patterns (FORBIDDEN)\n- ❌ NO crash on invalid JSON (reasoning: Must degrade gracefully with defaults)\n- ❌ NO crash on missing config file (reasoning: Must use defaults, not fail)\n- ❌ NO crash on permission errors (reasoning: Log warning, use defaults/no-op)\n- ❌ NO synchronous file I/O in hot path (reasoning: Config loads once at startup, logging is async-safe)\n- ❌ NO environment variable validation on every read (reasoning: Check once at loadConfig() startup)\n- ❌ NO unwrapping JSON.parse without try-catch (reasoning: Invalid JSON shouldn't crash MCP server)\n- ❌ NO assuming XDG_DIR exists (reasoning: Check existence, create if missing, handle permission errors)\n\n## Key Considerations\n\n**Config File Edge Cases**:\n- What happens if config directory doesn't exist? → Create parent directories with recursive: true, catch permission errors\n- What if config file has invalid JSON? → JSON.parse throws, catch Error, logWarning, use DEFAULTS, don't crash\n- What if JSONC has comments? → Strip // and /**/ comments before JSON.parse (JSONC format)\n- What if config file permission denied? → Log error to stderr, use DEFAULTS, don't crash\n\n** Logging Edge Cases**:\n- What happens if log directory doesn't exist? → mkdirSync with recursive: true, catch permission errors, degrade gracefully\n- What if log file write permission denied? → Use try-catch on fs.appendFileSync, log to stderr as fallback, don't crash\n- What if logs grow too large? → Log rotation not in initial scope, document in README\n- What if concurrent writes conflict? → fs.appendFileSync atomic on POSIX, document in logger docstring\n\n**Error Handling Strategy**:\n- Use try-catch around all fs operations\n- Never throw from config loading or logging (caller may not handle)\n- Always log errors to stderr as ultimate fallback\n- Degrade gracefully: missing config → DEFAULTS, logging failure → stderr only\n\n**Performance Considerations**:\n- Config loads once at startup (\u003c50ms), acceptable for MCP server start time\n- Logging uses fs.appendFileSync (simpler than async), acceptable since log volume low (\u003c1MB/session)\n- XDG config detection on startup, check 2 directories, fast operation\n\n**Reference Implementation**:\n- Study opencode-supermemory src/config.ts for pattern to follow (XDG detection, JSONC parsing, error handling)","status":"in_progress","priority":0,"issue_type":"feature","owner":"dmitry.polishuk@gmail.com","created_at":"2026-02-05T13:15:08.677492+03:00","created_by":"Dmitry Polishuk","updated_at":"2026-02-05T13:22:01.894044+03:00","dependencies":[{"issue_id":"kimi-supermemory-6tb","depends_on_id":"kimi-supermemory-sxo","type":"parent-child","created_at":"2026-02-05T13:15:12.242174+03:00","created_by":"Dmitry Polishuk"}]}
{"id":"kimi-supermemory-sxo","title":"Epic: Kimi Supermemory Feature Parity","design":"## Requirements (IMMUTABLE)\n- MCP server exposes 6 tools: add, search, get_context, list, forget, profile\n- supermemory_add requires: content, type (enum of 6 types), optional scope (user/project) defaults to project\n- supermemory_search supports: query, optional types filter, optional scope (user/project/all)\n- supermemory_get_context fetches user profile and project/context memories by cwd\n- supermemory_forget deletes memory by ID\n- supermemory_profile returns user profile facts (static/dynamic)\n- Hash-based scoping: User tag from KIMI_EMAIL env var, Project tag from git remote URL or directory name\n- Privacy: Strip \u003cprivate\u003e tags, reject fully-private content (sanitized empty)\n- Configuration: JSONC file (~/.config/kimi/supermemory.jsonc) with env var fallback, config supports keywordPatterns, similarityThreshold, limits, etc.\n- Logging: Structured logs to ~/.kimi-supermemory.log (timestamped JSON lines)\n- SKILL.md: Enhanced with memory types (6), scope guidelines, privacy examples, all 6 tools documented\n\n## Success Criteria (MUST ALL BE TRUE)\n- [ ] MCP server compiles (npm run build) and can be added via kimi mcp add\n- [ ] supermemory_add saves memory with type metadata, strips \u003cprivate\u003e tags, rejects fully-private content\n- [ ] supermemory_search filters by type/scope correctly, returns formatted results with similarity percentages\n- [ ] supermemory_get_context returns profile + project/context memories formatted as \u003csupermemory-context\u003e\n- [ ] User tag generated from KIMI_EMAIL (fallback to USERNAME), Project tag from git remote URL (fallback to directory name)\n- [ ] Configuration file loaded from ~/.config/kimi/supermemory.jsonc or ~/.kimi/supermemory.json with DEFAULTS\n- [ ] Logging writes to ~/.kimi-supermemory.log with timestamps and log levels (INFO, WARN, ERROR, DEBUG)\n- [ ] All 6 tools tested with sample data\n- [ ] Pre-commit hooks passing\n- [ ] Install script works (chmod +x install.sh; ./install.sh sets up MCP + skill)\n\n## Anti-Patterns (FORBIDDEN)\n- NO automatic hooks implementation (reasoning: kimi-cli does not support hooks, must be manual/agent-driven)\n- NO session start hooks (reasoning: Kimi CLI has no hook system, cannot auto-inject context)\n- NO keyword-based auto-save (reasoning: No pattern matching hooks in kimi-cli, must rely on SKILL.md guidance)\n- NO compaction hooks (reasoning: Kimi CLI has no compaction hooks, cannot preserve context across compaction)\n- NO shell command execution in MCP server (reasoning: MCP stdio server cannot access git config, use KIMI_EMAIL env var instead)\n- Hardcoded paths (reasoning: Use XDG config dir and env vars for cross-platform compatibility)\n- Skipping privacy filtering (reasoning: Must always strip \u003cprivate\u003e tags and reject fully-private content)\n- Logging to stdout (reasoning: Logs go to ~/.kimi-supermemory.log file only, stderr for startup only)\n\n## Approach\nImplement enhanced MCP server with 6 tools, hash-based scoping, privacy filtering, configuration system, logging, and comprehensive SKILL.md documentation. Build on existing supermemory client library, add new services modules (tags.ts, privacy.ts, config.ts, logger.ts), and update server.js with new tool handlers.\n\n## Architecture\n- MCP server (stdio) with 6 tools configured in mcp-server/src/server.js\n- SupermemoryClient extended with profile/forget methods\n- New services: src/services/tags.ts (hash-based scoping), src/services/privacy.ts (privacy filtering), src/services/config.ts (config loading), src/services/logger.ts (structured logging)\n- Enhanced SKILL.md with memory types, scope guidelines, privacy examples, workflow guidance\n- Configuration: ~/.config/kimi/supermemory.jsonc supporting all config options with env var fallback\n- Dependencies: supermemory npm package, @modelcontextprotocol/sdk, node:crypto, node:fs\n\n## Data Flow\nManual flow only: User invokes skill or agent decides. Agent calls tools manually when needed. No automatic hooks.\n\n## Design Rationale\n### Problem\nkimi-supermemory currently in MVP stage with basic tools only. Need feature parity with opencode-supermemory.\n\n### Research Findings\n**Codebase:** mcp-server/src/server.js, supermemory-client.js, skill/SKILL.md, install.sh\n**External:** opencode-supermemory (feature-complete), kimi-cli (NO hooks system)\n\n### Approaches Considered\n1. **Enhanced Skill + MCP** ✓ (Chosen - works within constraints)\n2. Flow Skill Workflows (Rejected - more complex)\n3. Wait for Hooks (Rejected - not available)\n\n### Scope Boundaries\n**In scope:** 6 tools, 6 memory types, hash-based scoping, privacy, config, logging, SKILL.md\n**Out of scope:** Automatic hooks, keyword auto-save, compaction hooks (deferred/never)\n\n### Open Questions\n- KIMI_EMAIL fallback (Decision: use USER/USERNAME or anonymous)\n- Config file permission errors (Decision: log warning, use defaults)","status":"open","priority":0,"issue_type":"epic","owner":"dmitry.polishuk@gmail.com","created_at":"2026-02-05T13:14:49.283702+03:00","created_by":"Dmitry Polishuk","updated_at":"2026-02-05T13:14:49.283702+03:00"}
